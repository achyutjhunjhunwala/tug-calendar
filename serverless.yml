service: tug-calendar

plugins:
  - serverless-esbuild
  - serverless-offline
  - serverless-prune-plugin

frameworkVersion: ~4.17.0

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, self:custom.defaultRegion}
  timeout: 30
  memorySize: 256
  environment:
    NODE_ENV: ${self:provider.stage}
    SERVICE_NAME: tug-calendar
    LOG_LEVEL: info
    TUG_NS_API_URL: ${ssm:TUG_NS_API_URL}
    TUG_NS_API_KEY: ${ssm:TUG_NS_API_KEY}
    ELASTIC_CLOUD_ID: ${ssm:ELASTIC_CLOUD_ID, ''}
    ELASTIC_API_KEY: ${ssm:ELASTIC_API_KEY, ''}

custom:
  defaultRegion: eu-central-1
  defaultStage: production
  currentStage: ${opt:stage, self:custom.defaultStage}
  environments:
    dev: 'dev'
    prod: 'prod'
  prune:
    automatic: true
    number: 3
  esbuild:
    bundle: true
    minify: ${self:custom.esbuild.minify.${self:provider.stage}, false}
    sourcemap: true
    external:
      - googleapis
      - google-auth-library
    target: node20
    platform: node
    concurrency: 10
    packager: npm
    keepOutputDirectory: false
  esbuildMinify:
    dev: false
    production: true

functions:
  daily:
    handler: src/handlers/daily.handler.handler
    events:
      - schedule:
          rate: cron(0 6 * * ? *)
          timezone: UTC

  weekly:
    handler: src/handlers/weekly.handler.handler
    events:
      - schedule:
          rate: cron(0 8 * * ? *)
          timezone: UTC

  monthly:
    handler: src/handlers/monthly.handler.handler
    events:
      - schedule:
          rate: cron(30 6 * * ? *)
          timezone: UTC
